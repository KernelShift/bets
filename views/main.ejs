<div class="grid">
  <div class="card">
    <h1>Main</h1>

    <% if (message) { %>
      <p class="muted"><%= message %></p>
    <% } %>

    <div class="pillrow">
      <div class="pill">Total deposited: <strong id="totalDepUsd">$<%= (myCreditedUsdCents/100).toFixed(2) %></strong></div>
      <div class="pill">My bet: <strong id="myBetUsd">$<%= (myBetUsdCents/100).toFixed(2) %></strong></div>
      <div class="pill">BTC/USD: <strong id="btcUsd">…</strong></div>
    </div>

    <hr />

    <h2>Bet</h2>
    <p class="muted">
      Bets are always <strong>2×</strong> your total deposited amount.
      Click below to fund your bet in Settings.
    </p>

    <a class="btn" href="/settings">Bet now</a>
    <p class="muted" style="margin-top:10px;">Settings will show your QR code and deposit address.</p>
  </div>

  <div class="card">
    <h2>Leaderboard (locked until you deposit)</h2>

    <% if (!hasBet) { %>
      <p class="muted">You must complete a deposit before you can see any user bets.</p>
    <% } else { %>
      <table>
        <thead>
  <tr>
    <th>Rank</th>
    <th>User</th>
    <th>Team</th>
    <th>Bet (USD)</th>
  </tr>
</thead>
        <tbody>
          <% top3.forEach((r, i) => { %>
            <tr>
              <td><%= i + 1 %></td>
              <td><strong><%= r.display_name %></strong> <span class="muted">@<%= r.username %></span></td>
              <td>$<%= (r.usd_cents/100).toFixed(2) %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <h3 class="mt">All other bets</h3>
      <table>
        <thead>
          <tr><th>User</th><th>Bet (USD)</th></tr>
        </thead>
        <tbody>
  <% if (top3.length === 0) { %>
    <tr>
      <td colspan="4" class="muted">No bets yet.</td>
    </tr>
  <% } %>

  <% top3.forEach((r, i) => { %>
    <tr>
      <td><%= i + 1 %></td>
      <td>
        <strong><%= r.display_name %></strong>
        <span class="muted">@<%= r.username %></span>
      </td>
      <td>
        <%= r.team === 'patriots' ? 'Patriots' : 'Seahawks' %>
      </td>
      <td>
        $<%= (r.usd_cents / 100).toFixed(2) %>
      </td>
    </tr>
  <% }) %>
</tbody>
      </table>
    <% } %>
  </div>
</div>

<script>
  async function refreshRate() {
    try {
      const r = await fetch('/api/rate');
      const j = await r.json();
      if (!j.ok) return;

      const btcUsd = document.getElementById('btcUsd');
      btcUsd.textContent = j.btcUsd
        ? `$${Number(j.btcUsd).toLocaleString(undefined, { maximumFractionDigits: 2 })}`
        : 'N/A';
    } catch {}
  }

  refreshRate();
  setInterval(refreshRate, 60_000);
</script>